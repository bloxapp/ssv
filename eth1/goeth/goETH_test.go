package goeth

import (
	"context"
	"encoding/json"
	"strings"
	"sync"
	"testing"
	"time"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/prysmaticlabs/prysm/async/event"
	"github.com/stretchr/testify/require"

	"github.com/bloxapp/ssv/eth1"
	"github.com/bloxapp/ssv/eth1/abiparser"
	"github.com/bloxapp/ssv/logging"
)

func TestEth1Client_handleEvent(t *testing.T) {
	logger := logging.TestLogger(t)

	tests := []struct {
		name           string
		version        eth1.Version
		operatorAdded  string
		validatorAdded string
	}{
		{
			name:           "v2 abi contract",
			version:        eth1.V1,
			operatorAdded:  rawOperatorAdded,
			validatorAdded: rawValidatorAdded,
		},
	}

	for _, test := range tests {
		test := test
		t.Run(test.name, func(t *testing.T) {
			ec := newEth1Client(test.version)
			contractAbi, err := abi.JSON(strings.NewReader(eth1.ContractABI(test.version)))
			require.NoError(t, err)
			require.NotNil(t, contractAbi)
			var vLogOperatorAdded types.Log
			err = json.Unmarshal([]byte(test.operatorAdded), &vLogOperatorAdded)
			require.NoError(t, err)
			var vLogValidatorAdded types.Log
			err = json.Unmarshal([]byte(test.validatorAdded), &vLogValidatorAdded)
			require.NoError(t, err)

			cn := make(chan *eth1.Event)
			sub := ec.EventsFeed().Subscribe(cn)
			require.NoError(t, err)
			var eventsWg sync.WaitGroup
			go func() {
				defer sub.Unsubscribe()
				for event := range cn {
					if ethEvent, ok := event.Data.(abiparser.OperatorAddedEvent); ok {
						require.NotNil(t, ethEvent)
						require.NotNil(t, ethEvent.PublicKey)
						eventsWg.Done()
						continue
					}
					if ethEvent, ok := event.Data.(abiparser.ValidatorAddedEvent); ok {
						require.NotNil(t, ethEvent)
						require.NotNil(t, ethEvent.PublicKey)
						eventsWg.Done()
						continue
					}
					panic("event data type is not founded")
				}
			}()

			eventsWg.Add(1)
			_, err = ec.handleEvent(logger, vLogOperatorAdded, contractAbi)
			require.NoError(t, err)

			time.Sleep(10 * time.Millisecond)
			eventsWg.Add(1)
			_, err = ec.handleEvent(logger, vLogValidatorAdded, contractAbi)
			require.NoError(t, err)

			eventsWg.Wait()
		})
	}
}

func newEth1Client(abiVersion eth1.Version) *eth1Client {
	ec := eth1Client{
		ctx:        context.TODO(),
		conn:       nil,
		eventsFeed: new(event.Feed),
		abiVersion: abiVersion,
	}
	return &ec
}

var rawOperatorAdded = `{
  "address": "0x3A23a7F455E853058d900f5dc86f1Bb1589b54F9",
  "topics": [
	"0xd839f31c14bd632f424e307b36abff63ca33684f77f28e35dc13718ef338f7f4",
	"0x0000000000000000000000000000000000000000000000000000000000000001",
	"0x00000000000000000000000097a6c1f3aab5427b901fb135ed492749191c0f1f"
  ],
  "data": "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000deb9cd9e0000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424e32705863457872656d643254586476527a684e64455679556a494b524768554d6b313164456c6d59556430566d784d654456574b326734616d7772646e6c7854315976636d784b5245566c517939484d7a567056304d3057455533526e464b55566331516d707651575a315458685165677052517a5a364d45453162314933656e52755748553263305633546b684a534668335245464954486c54645664514d334247596c6f30516e63356231465a54554a6d62564e734c33685852307379566e4e336156686b436b4e4663555a4b526d644e55466b334e6c4a5159306f325232646b545763725756525257565646616d6c52546a4670646d4a4b5a6a5257615570435254637262564e7465465a4e4e54417a566d6c7951575a6e646b494b656e426e64544e7a64485a496448705256315a3265484a304e545230526d39444d48526d5745315252584e53553056745456526f566b686f63566f725a544a434f43396b545751325231466f646e45355a58523152517068516b786f536c704655586c704d6b6c7055553032556c6732613031765a476447556d6376656d747454465a5851305649547a457a61465635526b6f78616e67314c304d3562454979553256454e57396a64316834436d4a525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b00000000000000000000000000000000000000000000000000000000",
  "blockNumber": "0x6E1070",
  "transactionHash": "0xf9b5aeb83f01d1080d26961b770926a592d5d111af68dd8d587244a63219b616"
}`

var rawValidatorAdded = `{
  "address": "0x4b133c68a084b8a88f72edcd7944b69c8d545f03",
  "topics": [
	"0x48a3ea0796746043948f6341d17ff8200937b99262a0b48c2663b951ed7114e5",
	"0x00000000000000000000000077fc6e8b24a623725d935bc88057098d0bca6eb3"
  ],
  "data": "0x000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017c4071580000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000532d024bb0158000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000030b24454393691331ee6eba4ffa2dbb2600b9859f908c3e648b6c6de9e1dea3e9329866015d08355c8d451427762b913d1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000520823f86dfcae5771e9b847c07ed6dda49211274db079f3397b3b06ab7291cebd688f63cb5648ca535c4ec4f9e2b89a48515a035dc24f4738ada942b72d32f75a7e72ac8a8c39d73a6fd633d0f58cadc4618dc70c8160cab5573d541c88a6aebada0acbbeacd49f2931c8c0c548d1b0f69cd468c803ec3fe06bddf08186ae3b64e0b5f1762feb141a06e71c828cedd3c878a08a40fd84d3a0449308c458fd324e67eb6df89e28bf6c304a1e71dcb8c9823b85c2dcca82a980cffb994da194e70b487d02db1ff328b6a8d5f6b519ffc1b524753ce8ed56d4ec1a3cdddc3b24f427b22caa351a1fa0d9f523bd279756ec38080c4850691c1f520dee49a9f4267c0a7a53c7818d165681c9a615a391ee5e4cc9c0e51725c1a92f7e92a393afe4f8f3f35503f241288822a1d721f5c164ea7f85d2b43b638678593d670e79c17a0e1398ac6bbd3ef7ccbdf67e38f6d058ffc5319280868c9a44529b1a4ea7f73792680e67693c502ad9053935edc312c48a94a0d18c71c18af8eb46ae8979d30f176969063430c14ef18a51b3dca4f8775551f4e1fc6a651ee909fc4f7b872c041514a01b4d88b972be86960e3472419ef1577c92af61d572e4e07b32bb38a0e52a1c75f03e1cee80d053b97e3e238c022521c48c6c1dc0f0def8fa0472d7669095b0e9304e63af8b5a9928d9fcf4de166029d88891d10ae6abafe150cc6e9aa6464d76064b16a19b09dad4556dffa580d14cd6755fa2274022abbc917eb7a50f296a153781742c2f101cf280b7f095bf443d51be4dcdd114804fb40ba496c16a3c3a3e82d8645833e51c22cebb78ce4b18b6b9eb3b480f5478b3ed97b5a93b705f41d05ed8423f424c5d05317c4e6e53e954570a46027361f7f3f18a581860720dac25afc00f4378a35439fd860ccbc0f0586ae6cf44d53f828faf77c1949bfe58c428de7263d48b1f7ecbb24a25c6abc11aa6105fe41a9a1f608c6895d808e8ca805efd306ec8774201a63e7d9220e031c5e8abdde49f5d56590637a5234b4b35a20875d5e0a5b06c2834dae47dd50633c371ef1071ea3d79a8ce727c2e83d3fae85a596112404875e847c743ddde50bc13b5d661f558e4d02f29b972188418d2f875d0603abbe9ab5c1fc19ae80636d9aa3a6c80be21b2970b84aa4659244424f943b3a99c8ec73304bcc8fc51519f1655ad6f75954af3cb238e946ac50aa365fd6538a7190b6e64b320f822a0010e92e1e4f3d773d25c4e29b3d590e75b4ebfecd6c059df2060f44344dda27f2f794aeb3dfcde62c7b24b80ff95ff1246d05805a12028d9840316f6b8368b60d2a824cc14b02d25a46b689e4519dd9963b5786ff9fa0c695fbdff455499a8f6cc88261b498e90223c0abca38dfe188eef0ac4680f6ac172fdf6b4a343cb1f090a8ce427ef4c745a2408f9ffe67c5b8eb17e7cc2e5851db5f5c75c0658afea00dc1552caf7ef745d2e5e057ccd3b177de22d989fe97bcac17471d0e8ee330a6d9788c6927b1991e784ec61deef91afad21895718e3fa751a782cf66c5911e3f2148dffb01e7e09dcbce8053e060df505f1121202017b34010ddbf02e63b40b8e88a73ac75eb239c401f136b255aded2201de167c9b6ee140de2d307712c8db8e958c5bab3de27d6a40e0b1211ccb634ca9204ce1bda71064f3bee1546f97979c9ec07cd5b4cb5befd7cf8ac930ad74111f381c72d18d3cf1aefef073630cc7bfef722650023032d6493fea494b3b01c95790b08609c9c039a1849fbe47042a29e98ce92f87641647db7d610357c087de95218ea357284828925c21ff7685f01f1b0e5ebadef7d1e763c64ee06d29f4ded10075d39",
  "blockNumber": "0x89EBFF",
  "transactionHash": "0x921a3f836fb873a40aa4f83097e52b69225334c49674dc262b2bb90d27e3a801"
}`
