package eth1

import (
	"encoding/hex"
	"encoding/json"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/pkg/errors"
	"github.com/stretchr/testify/require"

	"github.com/bloxapp/ssv/eth1/abiparser"
	"github.com/bloxapp/ssv/logging"
)

func TestParseOperatorAddedEvent(t *testing.T) {
	var rawOperatorAdded = `{
  "address": "0x3A23a7F455E853058d900f5dc86f1Bb1589b54F9",
  "topics": [
	"0xd839f31c14bd632f424e307b36abff63ca33684f77f28e35dc13718ef338f7f4",
	"0x0000000000000000000000000000000000000000000000000000000000000001",
	"0x0000000000000000000000009d4d2d2dd7f11953535691786690610512e26b6c"
  ],
  "data": "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000deb9cd9e0000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424d5667324d5546585930303151554e4c61474e354d546c556145494b627939484d576c684e3142794f565572616c4a35615759355a6a4179524739736430393156325a4c4c7a645356556c684f45684562484276516c564552446b77525456515547644a5379397354584234527974586277707751324e3562544270576b395554304a7a4e44453562456833547a41346258466a61314a735a4567355745786d626d59325554687157465235596d3179597a64574e6d77794e56707263546c3455306f7762485231436e646d546e5654537a4e435a6e46744e6b51784f55593061545643626d56615357686a52564a54596c464c5744467862574e71596e5a464c326379516b6f34547a68615a5567726430527a54484a694e6e5a585156494b5933425957473175656c4533566c70365a6b6c485447564c5655314354546836535730726358493452475a34534568536556553151544533634655346379394d4e5570355258453152474a6a6332513264486c6e625170355545394259554e7a576c6456524549335547684c4f487055575539575969394d4d316c6e53545534626a4658656b35494d307335636d467265557070546d55785445394756565a7a51544644556e68745132597a436d6c525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b00000000000000000000000000000000000000000000000000000000",
  "blockNumber": "0x843735",
  "transactionHash": "0x4f4f9c1e37cf0800a201227e8fa3cad6f8f246ac1cca1cb90e2c3311538b300c"
}`

	t.Run("operator added", func(t *testing.T) {
		LogOperatorAdded, contractAbi := unmarshalLog(t, rawOperatorAdded, V1)
		abiParser := NewParser(logging.TestLogger(t), V1)
		parsed, err := abiParser.ParseOperatorAddedEvent(*LogOperatorAdded, contractAbi)
		var malformedEventErr *abiparser.MalformedEventError
		require.NoError(t, err)
		require.False(t, errors.As(err, &malformedEventErr))
		require.NotNil(t, contractAbi)
		require.NotNil(t, parsed)
		require.Equal(t, "LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBMVg2MUFXY001QUNLaGN5MTlUaEIKby9HMWlhN1ByOVUralJ5aWY5ZjAyRG9sd091V2ZLLzdSVUlhOEhEbHBvQlVERDkwRTVQUGdJSy9sTXB4RytXbwpwQ2N5bTBpWk9UT0JzNDE5bEh3TzA4bXFja1JsZEg5WExmbmY2UThqWFR5Ym1yYzdWNmwyNVprcTl4U0owbHR1CndmTnVTSzNCZnFtNkQxOUY0aTVCbmVaSWhjRVJTYlFLWDFxbWNqYnZFL2cyQko4TzhaZUgrd0RzTHJiNnZXQVIKY3BYWG1uelE3Vlp6ZklHTGVLVU1CTTh6SW0rcXI4RGZ4SEhSeVU1QTE3cFU4cy9MNUp5RXE1RGJjc2Q2dHlnbQp5UE9BYUNzWldVREI3UGhLOHpUWU9WYi9MM1lnSTU4bjFXek5IM0s5cmFreUppTmUxTE9GVVZzQTFDUnhtQ2YzCmlRSURBUUFCCi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS0K",
			string(parsed.PublicKey))
		require.Equal(t, "0x9d4D2d2dd7F11953535691786690610512E26b6C", parsed.Owner.Hex())
		require.Equal(t, uint64(1), parsed.OperatorId)
	})
}

func TestParseValidatorAddedEvent(t *testing.T) {
	var rawValidatorAdded = `{
  "address": "0x3A23a7F455E853058d900f5dc86f1Bb1589b54F9",
  "topics": [
	"0xd432d53fd23906d0269fb9864b3832f32b83148df4315eab6ca914225c7fa2f4",
	"0x0000000000000000000000005cc0dde14e7256340cc820415a6022a7d1c93a35"
  ],
  "data": "0x000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003499530c000000000000000000000000000000000000000000000000ebec21ee1da400000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000030889b8e1896fd53a41716c07cc580a335d613350f28fec39f3cdc40b29c15566303e653c3b6ea4d532c0ffba7e04170e30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004c201828a47a13f6b0d11f2071ca4231d0f2aa885aa84e485385d30f778efb1984dca8fe01a6d9fa93b81a0c6d7293c8ef59e5ea99e14b49e76a10b78ec0a636932a40fa11238ddf8432a936fd4afbb1502ab973a66d718bb81c7a90a3bfa467030267ea693a0108c16eec1d7fe83e941e36b32e8a2b7f0f40a0ddc3c9b88367aab30d5e951504d4a428cb464a19f672631214e882625e375bf6f5ba28b5bdb78aa1e3495fff78ee60a99b3df6392172757fcc42fe9752aa91a2efceb7f6302e3df4b7d6865116867c73408dd2c39562e1ceb44b768a02a03b7e9e731863081a07a097089a8a25f190a598eca55a83f42e7045dd5cddea6f6c14250e1cef395bdea100987daa876a76b682a8a4d8e146fe7aea0f41dacac5585b45685bcd3effcfcd0079f78cce7b59eb5082821cdee4ef05cc69df843b294054bef40531c7e7b8971d2c317249105ffc52e2e9ba0365126eba0f56281a6b185782051efdf601e57b1e8bb942dced6f6b3678d499209863eb27df3ce88fd6165ed62347865e87f79e43344cc4277f53f22d08c2dfd96599677036088052a988e8885ae93b4039b0488a390b1db87f500addc188b217789dd6f925eeb182753068bc6ba0067ac4ea00ecd6a718755fb4881e47a414ee3176c002a05ec0a24f010c22de5943bf8e40df48b5380f32ad77e88f6534181d04b53681ef0d2dd916c46af415a8da13fa4350eb11bffbf05aa107235cce55fbc62f03a0bd341b410e2a8eb688c7a81d5148e9adc8c56d2a7ff859af64dfc01fa0885d071f27a5224868e061c763f697c4cae73f1ad8790a4f3351fb7c0da41ef51e703b54158669d6c4b468595db1d67eaf373b42e77519d27dca1c8e0e9038b7df6c11cba7ae2de0871bc96c366b6cb49b7bbc2757c74171e7d34f70a5026d0d3e94ade51323a49e0c07d5c49e6267268d59645cdf58c25ef27cb8857d80423569f195b27f211478ebb54ffed7c132c1912777304dc3742c15dff57a471388d66ea3e39bdd0861f45b37c94eec1d50c297c862ea4c5b1f2db7abd78900a10921f0634f75468e63ae1d21b1ad648b8ce7bc03196d0b09588991fb2261ec8314cdcf2012036625f173faad7489227185cda557876d9b8018e8581d4bce12d551adaa67ef881d8d90dc0549b985bd9b5809102b09d20525f96333c2bc92cc746af54e6f30d7a7ff008f500735d6e0b551b8898d4191e0cecaceb8a446879f37b4dda063578a06bb7aa19313730c40790e9a516e7d5d2d9c212304f189c5d8eb76a9b369d488376196752d8f5d67c5df05d1b83efb053ce8b7ad23de2d8915bc3fa2ae9e3ca3b71bdc5f61ad2136917f2152ab32d5d0bc3553a55391e99a5d0519decfc09e24a7197bacdeccde61c8a599709cd7b9346ba0b027db8a4d112840dc810fc8033f62b358168ac8a8586f1ffa3fd77dadfa50870fbb5110e3e715dab8e8ae2bc860e2ad6d31ac49be4bb2f87043ad4274a6ceccff3da875b45259827120fc247cf2a721e3b0758ec19e0060a4a148ff452b1f074a82dd34aef1d58ad690c81199354315afb33c2cb4d24cd73a91f4d4961536b37227a2ca7f5643d97a05e6b75f321303bf332c378ee43a26c0e3548c0be0bdb6833abf6388274ff15151771f19f6113f8adeb596a01d5d9e781f7985799ba2d6369e0ef0283df95a1fb4bbc925326021a9c0936b0dc9c2ecac5ef181dd0000000000000000000000000000000000000000000000000000000000000",
  "blockNumber": "0x6E10A0",
  "transactionHash": "0x56f069d696c03aad5cf40681a0e55c27bcf5659c1ea40e9ba46b1e0f163de281"
}`

	t.Run("validator added", func(t *testing.T) {
		vLogValidatorAdded, contractAbi := unmarshalLog(t, rawValidatorAdded, V1)
		abiParser := NewParser(logging.TestLogger(t), V1)
		parsed, err := abiParser.ParseValidatorAddedEvent(*vLogValidatorAdded, contractAbi)
		var malformedEventErr *abiparser.MalformedEventError
		require.NoError(t, err)
		require.NotNil(t, contractAbi)
		require.False(t, errors.As(err, &malformedEventErr))
		require.NotNil(t, parsed)
		require.Equal(t, "889b8e1896fd53a41716c07cc580a335d613350f28fec39f3cdc40b29c15566303e653c3b6ea4d532c0ffba7e04170e3", hex.EncodeToString(parsed.PublicKey))
		require.Equal(t, "0x5cC0DdE14E7256340CC820415a6022a7d1c93A35", parsed.Owner.Hex())
		operators := []uint64{1, 2, 3, 4}
		for i, opID := range parsed.OperatorIds {
			require.Equal(t, operators[i], opID)
		}
		shares := []string{"8a47a13f6b0d11f2071ca4231d0f2aa885aa84e485385d30f778efb1984dca8fe01a6d9fa93b81a0c6d7293c8ef59e5e", "a99e14b49e76a10b78ec0a636932a40fa11238ddf8432a936fd4afbb1502ab973a66d718bb81c7a90a3bfa467030267e", "a693a0108c16eec1d7fe83e941e36b32e8a2b7f0f40a0ddc3c9b88367aab30d5e951504d4a428cb464a19f672631214e", "882625e375bf6f5ba28b5bdb78aa1e3495fff78ee60a99b3df6392172757fcc42fe9752aa91a2efceb7f6302e3df4b7d"}
		for i, pk := range parsed.SharePublicKeys {
			require.Equal(t, shares[i], hex.EncodeToString(pk))
		}
	})
}

func unmarshalLog(t *testing.T, rawOperatorAdded string, abiVersion Version) (*types.Log, abi.ABI) {
	var vLogOperatorAdded types.Log
	err := json.Unmarshal([]byte(rawOperatorAdded), &vLogOperatorAdded)
	require.NoError(t, err)
	contractAbi, err := abi.JSON(strings.NewReader(ContractABI(abiVersion)))
	require.NoError(t, err)
	require.NotNil(t, contractAbi)
	return &vLogOperatorAdded, contractAbi
}
