package eth1

import (
	"encoding/hex"
	"encoding/json"
	"strings"
	"testing"

	"github.com/bloxapp/ssv/eth1/abiparser"
	"github.com/bloxapp/ssv/utils/logex"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/pkg/errors"
	"github.com/stretchr/testify/require"
	"go.uber.org/zap"
)

func TestParseOperatorAddedEvent(t *testing.T) {
	OldRawOperatorAdded := `{
  "address": "0x9573c41f0ed8b72f3bd6a9ba6e3e15426a0aa65b",
  "topics": [
	"0x39b34f12d0a1eb39d220d2acd5e293c894753a36ac66da43b832c9f1fdb8254e"
  ],
  "data": "0x000000000000000000000000000000000000000000000000000000000000006000000000000000000000000067ce5c69260bd819b4e0ad13f4b873074d47981100000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000005617364617300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642623364464e303946596e643554477432636c6f7756465530616d6f4b6232393553555a34546e5a6e636c6b34526d6f7256334e736556705562486c714f4656455a6b5a7957576731565734796454525a545752425a53746a5547597857457372515339514f5668594e3039434e47356d4d51705062306457516a5a33636b4d76616d684d596e5a50534459314d484a3556566c766347565a6147785457486848626b5130646d4e3256485a6a6355784d516974315a54497661586c546546464d634670534c7a5a57436e4e554d325a47636b5676626e704756484675526b4e33513059794f476c51626b7057516d70594e6c517653474e55536a553153555272596e52766447467956545a6a6433644f543068755347743656334a324e326b4b64486c5161314930523255784d576874566b633555577053543351314e6d566f57475a4763305a764e55317855335a7863466c776246687253533936565535744f476f76624846465a465577556c6856636a517854416f7961486c4c57533977566d707a5a32316c56484e4f4e79396163554644613068355a546c47596d74574f565976566d4a556144646f56315a4d5648464855326733516c6b765244646e643039335a6e564c61584579436c52335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330414c53304b00000000000000000000000000000000000000000000000000000000",
  "blockNumber": "0x49f59c",
  "transactionHash": "0x097d9a621ace2ca0c78d115d833edc1901bfe75f107a7b3f427663ea308c12ca",
  "transactionIndex": "0xf",
  "blockHash": "0x9542ecebe9d541e2575cb5577dfd4b73c9b0c3ab634fcac4ce0ff319249c90e4",
  "logIndex": "0xf",
  "removed": false
}`

	rawOperatorAddedV2 := `{
   "address":"0x5b46c3659f12D23049Dca9a4edec5E9B24f8948d",
   "topics":[
      "0xf4ee59ccbdde534d8daaaa4e61e0bbbba482910ef646678a63ac7686564c2db2",
      "0x0000000000000000000000000000000000000000000000000000000000000007",
      "0x00000000000000000000000097a6c1f3aab5427b901fb135ed492749191c0f1f"
   ],
   "data":"0x000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000025ed2a5f37400000000000000000000000000000000000000000000000000000000000000004596f596f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642634535366333685851314275556b707652437476636c527a54464d4b536a6c56574745774d32526e616c59305a6c42574d5574484e544e4c556e6847634752494e544a77515456575530394463585246625745304d585a756355745561334652633239765347343455474e4353587047656770556346493261576c4764566c764d3170514e55567663473546536e6c76517a4a4b57556f3254575a72537a527051304a48526939754e575a334d6a565663486c705254687753554652625746444e55526d616c644b436b355261304a51546a6730576b31346132493162544d31526e527a566b78516232737a5a6b465165584a6a5545524d63577433556b394462587076516e42445544466d656b5a6b646a4e43646c566c6145523465456f4b55474a4b646d68775a6d4a6c596b645362475679616a5653527939536154644b59314678576d687a56564674546b593055336b35536e413165697470546d64716145387857544a474e455a4f63335532596e70555a6770544d3073725755643354326c4962697453654452775a44564553575a77543035485a6c56735254525a533264524d57745354456c4c4f46417762585668546e513052697468555564744d586c444e544661636c4931436c68335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b00000000000000000000000000000000000000000000000000000000",
   "transactionHash":"0xd0002d00a3e7639d6f41829f245ecbd33ee1cb8df205162d62ea0d4e8e1575c3"
}`

	logger := logex.Build("test", zap.DebugLevel, nil)
	t.Run("legacy operator added", func(t *testing.T) {
		legacyLogOperatorAdded, legacyContractAbi := unmarshalLog(t, OldRawOperatorAdded, Legacy)
		abiParser := NewParser(logger, Legacy)
		parsed, err := abiParser.ParseOperatorAddedEvent(*legacyLogOperatorAdded, legacyContractAbi)
		var malformedEventErr *abiparser.MalformedEventError
		require.NoError(t, err)
		require.NotNil(t, legacyContractAbi)
		require.False(t, errors.As(err, &malformedEventErr))
		require.NotNil(t, parsed)
		require.Equal(t, "asdas", parsed.Name)
		require.Equal(t, "0x67Ce5c69260bd819B4e0AD13f4b873074D479811", parsed.OwnerAddress.Hex())
	})

	t.Run("v2 operator added", func(t *testing.T) {
		LogOperatorAdded, contractAbi := unmarshalLog(t, rawOperatorAddedV2, V2)
		abiParser := NewParser(logger, V2)
		parsed, err := abiParser.ParseOperatorAddedEvent(*LogOperatorAdded, contractAbi)
		var malformedEventErr *abiparser.MalformedEventError
		require.NoError(t, err)
		require.False(t, errors.As(err, &malformedEventErr))
		require.NotNil(t, contractAbi)
		require.NotNil(t, parsed)
		require.Equal(t, "YoYo", parsed.Name)
		require.Equal(t, "LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBcE56c3hXQ1BuUkpvRCtvclRzTFMKSjlVWGEwM2RnalY0ZlBWMUtHNTNLUnhGcGRINTJwQTVWU09DcXRFbWE0MXZucUtUa3FRc29vSG44UGNCSXpGegpUcFI2aWlGdVlvM1pQNUVvcG5FSnlvQzJKWUo2TWZrSzRpQ0JHRi9uNWZ3MjVVcHlpRThwSUFRbWFDNURmaldKCk5Ra0JQTjg0Wk14a2I1bTM1RnRzVkxQb2szZkFQeXJjUERMcWt3Uk9DbXpvQnBDUDFmekZkdjNCdlVlaER4eEoKUGJKdmhwZmJlYkdSbGVyajVSRy9SaTdKY1FxWmhzVVFtTkY0U3k5SnA1eitpTmdqaE8xWTJGNEZOc3U2YnpUZgpTM0srWUd3T2lIbitSeDRwZDVESWZwT05HZlVsRTRZS2dRMWtSTElLOFAwbXVhTnQ0RithUUdtMXlDNTFaclI1Clh3SURBUUFCCi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS0K",
			string(parsed.PublicKey))
		require.Equal(t, "0x97a6C1f3aaB5427B901fb135ED492749191C0f1F", parsed.OwnerAddress.Hex())
		require.Equal(t, uint64(7), parsed.Id.Uint64())
	})
}

func TestParseValidatorAddedEvent(t *testing.T) {
	legacyRawValidatorAdded := `{
  "address": "0x9573c41f0ed8b72f3bd6a9ba6e3e15426a0aa65b",
  "topics": [
	"0x8674c0b4bd63a0814bf1ae6d64d71cf4886880a8bdbd3d7c1eca89a37d1e9271"
  ],
  "data": "0x000000000000000000000000feedb14d8b2c76fdf808c29818b06b830e8c2c0e000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000003091db3a13ab428a6c9c20e7104488cb6961abeab60e56cf4ba199eed3b5f6e7ced670ecb066c9704dc2fa93133792381c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000b80000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424d455a336545684c647a4a355a7a466a555731486446464b4d6d344b52437474646d64475331564c536e6c34515468365543394e4f446379596c70735233684b62305a4a624735684d44564d634868436545466e543035705a4556584d335a3165485647533245344f4467355558425957517070565751354d316848636b4e5a574546794f557074576a686964456c5554304e3464445634613346336557746855455a784d585647646e46774f4852574f54426f596b3536536c70354d6d786f553156794f485268436b6c755130467963304670616e7058533267314e6d705751314a4d51305253623363324d324a436456424c6545646d5a5735425a5564586448466b595842325531645861485a4a63584278636b7050566b4e576356594b63334e594d3278304f57517a656b453254325a4c4d54425455323478645545764d5539584e6a4e32596e4670534446775a475a73527a427952466b7262554e566269397453566f7a4d533876556a4e5a5a7a6856595170706246685054545a32555642685a44466c527a525253544e4761465a4d61456f77616a4d3462555a6855306446616a46435257687a52314e61536e5258526c6c684f555a4b566c4e4464587035516e705654556876436c68525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003092aa9de41ee36d746a37c2696816103a052bdcf03af3a9d0bf517fb9ef3c30501fcf34a73a57c78f3d3ca23da1aec4580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000158782b6f4b3052687365507254432f4e77486766625870365a6b343679676375412b6551313733546343303771427239484a714261574636536d552f6c3833663067445474554b35434a364c7032445867437033574b476c6c513775704b72467a77517a46725252503132425968416c746a5a645a347068504f6e4343687637716e7362706d633976494f78654b4963416433696c4e51594857484c302b5758546c4c392f556343565461514d38685268656c6636504a67654e7a5145384f66413555624131667735595a51423865647932446d34734c4642617542386a4548554d4e526458413974356868633345617a7972695845736d48613047494a736e3537747a4c324a375455363566626f6d43766e57517743635a534639344142494477324b54324e6755524c34705932674870756a452f514a53573733537478593343444162654f39754979566448524b735941644238773d3d000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424d465135526d63724d324a6f5a6b394d63546849524445324d6b4d4b5a4468704d6c5a44576a64475430647756484e4f4d6a52344f4578345754524e526d354b5a56464a656b3030633152594f546c4756324e4c5232644b62307842537a566b65545272546e465a57554675533051765451706a4e3255316348684b53465a4965484a595456567a5955744e55304a6d5a33706f556a5a6e63444e584d47704e53305a3354477836564670686231526a616c56455557356d4d336c514f584577626a426f64556879436e6c465444526862586b354f47313363453158576c70564f57644e576a4a4952544673634846305557396d516a417959574d79533146764f544e46546a4252546d6330656d6857526d466a645656355955703662326f4b6448646c574652435a574a7157453173645749315a584e5855334a45626a64555a465646654745725530566b56444261576d39526347704b596b5275646c526a643039766333557a545374505a44524e5555564f63517078556a52594e5751306133427956557377626d395864455658626d7733555445314d486c6b4f55355254305a5961304e6d57537472646c5259567a4277597a46776232466c5a336c4c64555a43566d704a52446478436b4e335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030a1000cd6aaffd95ebe6baff24fe4d9544b7e0ad6727b54ea36cf8117bd34b19fbb586e1ba16ce84084c0ba0a3fa8f3620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000158435a6d6c4d4b42612f43527568346c4d57764d5a342b5a476476675373556a33416e386b573062544f77626862574d626b656d6667644651326e50344458304d374861703446584c3251774d464c6865474353534f6b7649784b42474c4c5439523253737453706358446e7955634d51464244764b5871365673537167644f61375048485a6874566b6775457037414b59566452554d345258657234536a4e6b4968474d6f5a506f775935665067784c33355864473537736c412b35745869596a4b326b4f6663685562306f6e33312f66356c365a386c31377536427679484d5a756658313932554b597a45566241505a64657a674e6e69506c35495452784f2b49423644415145323233754a6a2b48357857377570524d6a58656943796a34567769437354512b483933787151594c62553051316e4c566a3571525567534f674d52434a6133536432536537777531497633694d773d3d000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424e32705863457872656d643254586476527a684e64455679556a494b524768554d6b313164456c6d59556430566d784d654456574b326734616d7772646e6c7854315976636d784b5245566c517939484d7a567056304d3057455533526e464b55566331516d707651575a315458685165677052517a5a364d45453162314933656e52755748553263305633546b684a534668335245464954486c54645664514d334247596c6f30516e63356231465a54554a6d62564e734c33685852307379566e4e336156686b436b4e4663555a4b526d644e55466b334e6c4a5159306f325232646b545763725756525257565646616d6c52546a4670646d4a4b5a6a5257615570435254637262564e7465465a4e4e54417a566d6c7951575a6e646b494b656e426e64544e7a64485a496448705256315a3265484a304e545230526d39444d48526d5745315252584e53553056745456526f566b686f63566f725a544a434f43396b545751325231466f646e45355a58523152517068516b786f536c704655586c704d6b6c7055553032556c6732613031765a476447556d6376656d747454465a5851305649547a457a61465635526b6f78616e67314c304d3562454979553256454e57396a64316834436d4a525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030887c4fbcaf5dafaa60ea73f1944be4a3eaaf55f15fac8d2e717e10d6fcdb4c82cf000305acd3fe6eb43b51cd615df2670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001587468336178485a73434f75687268724c4d4c4e394874717977697533494b454479394c4d77504f6b32494d3066622f576744465671744b4d2b626b6c69327163585273346b6c39382f506e6d7378725630664a786871415343376746424955536739674a356864757a68676d6c7672443639554c376c627847545037676f337a32345741335372646254434f32675553496537675a437349796f4b617a466c4d46477342464c436647676264585555324f4e6f334937703564634271707072324e516a6f745475496146507568684a4545706436685a6b2b49766179325246655448796674704a79394569583241397478364459386b456b4269305841442f796d553230707053307a477463674b7a2b312f645a695963315347444a7a6f42424431777a737848642f6c353752766f6533372b52764d424d3853744c42436a3053324f46485673634b347545375070654368623758773d3d000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642623364464e303946596e643554477432636c6f7756465530616d6f4b6232393553555a34546e5a6e636c6b34526d6f7256334e736556705562486c714f4656455a6b5a7957576731565734796454525a545752425a53746a5547597857457372515339514f5668594e3039434e47356d4d51705062306457516a5a33636b4d76616d684d596e5a50534459314d484a3556566c766347565a6147785457486848626b5130646d4e3256485a6a6355784d516974315a54497661586c546546464d634670534c7a5a57436e4e554d325a47636b5676626e704756484675526b4e33513059794f476c51626b7057516d70594e6c513153474e55536a553153555272596e52766447467956545a6a6433644f543068755347743656334a324e326b4b64486c5161314930523255784d576874566b633555577053543351314e6d566f57475a4763305a764e55317855335a7863466c776246687253533936565535744f476f76624846465a465577556c6856636a517854416f7961486c4c57533977566d707a5a32316c56484e4f4e79396163554644613068355a546c47596d74574f565976566d4a556144646f56315a4d5648464855326733516c6b765244646e643039335a6e564c61584579436c52335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030b860fe4b61a3f9295a08b53f6676443fb3ba19ed4502540a18c9d30268c4f7018b3b039d6528f06f08a63e4cb0ca67d30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001586859562b4378525131614d4f4d686b4d5174706d4650316c524732433454545a51414135654866746a63484a6b6c745872364b7877614c6f4d704f367170313333592f637a325a362b5553565554702b797655312b4e49306152504835534362557058376e7057497148306f4756656f674a4550514650374e65336c376a493761583876556a6b46596a7a636d52496e696e5a7370723455593344626953582f476a327a795644462f2b5941335a2f2f49366a77746561386c6c31576c3978412b794f70427a356b2b4b726134714a787452367a7668714d646532594836305a424a515342796934722b4c5035642f3279496b4f39344f7451326f4c41576d2f756778436f4d747152314e37444e4e633467614b444869722f7658676b514f475178424e396265353352345179386b69354869655953594e6e4b2f6d6e387374304e307250756442394a334b346278796657574f41413d3d0000000000000000",
  "blockNumber": "0x4a3a2e",
  "transactionHash": "0x20b673d0be280a38daa4f636ec6ad1108c0635dcb35c603f8e401a4120a2b506",
  "transactionIndex": "0x3",
  "blockHash": "0x579a98700bc9f9b1dc6ea3d00f9fd43bf28bd795f615210fd138fe724b8654d4",
  "logIndex": "0x2",
  "removed": false
}`

	rawValidatorAddedV2 := `{
   "address":"0x76B1c8E85A43c665eBC4aE1f8ea0Aebd2CAdd11e",
   "topics":[
      "0x6e286e5e846c983ab60768f7550b0305388a1c452194a6db2cd6902bcf52e5bb"
   ],
   "data":"0x000000000000000000000000feedb14d8b2c76fdf808c29818b06b830e8c2c0e00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000030a49871a0b87d674435ac1bb62bb78a27a29bc0901ad7a3b77e564c02644f55da0e72c18e888ca78f8290a8b9c0825dd200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000003090d8b15e48a65c48e0e90184c345ac49db1073550841087150199f9e25f76595662104703c46b12f1001cbba59211361000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030896d999a3cbbb4b3a462fefdb351b2f94f4c14bb44abe99701c77632140d807d3c5b46e8f66e67e8479d787e87636e10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030a0a90424720deede84ecea2d5855c3b56d53726d585fc32c52c239b317d6c4d93abb4938556c81a42c6fed0e0c60cd740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000309177946b30a048cb6b29037c6c1d72cf61bd9a093497d40f93df8df76e813de5d64c74114f5373e8c18d7c8634e0a40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000158524c38536f546278683852666c565061506734454454356e5a6665516957465063563979794d2b534a7652383676377375766f636d466e33794c534552384e7459345263713147674333713138726c656b4f4959483457674e3078644667424b734e76315a764333484775486b584b31657548637a6a632b33697175334d4e6377556655732f586d4f6d6d492f6c417972784c5a4e3743685964594f2f3946554c797435336c663169306e7756724d4c6e39466e566564726d69784d58516f4c55334b5970427a556c68466d354d77595077757130454d3543727936393731546b6e4c4b2b3157734d79306841347335795756446a6e417a38613774415979364d37427449644843564841623146385661356e534343497872687246617151647055324e48486551795939444a635950786b5a38374a45716d796f643447693669336a756275677651395862326b49386b6a495554513d3d000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001584831354d624b69512f344b596544612b4a52367968547978366b782b71703967366336627533647a4249465971616c33754654706c4e366965695a665a78435052674b55356c353433483670724c35306d7952716b527171466d4b5941666976775641776862344c654f4b56342b4a752b632f7837367838616475444a74506d674d3559343964612f724459346d664e704d6436425561435651476139534d36366759664534574276516170776478397a626466593345574246397152494c6e70764539556776496649595956566b4534486a68636237387366756a6748756c376b56745056696336506a3034725a77756252723533764b2b78472f2f6c30422b4f31456f496b6f7048446b74615674712f424c39654b482f593735694d79762f7445667659326f2f776b3043686d75335449456d334b61766670694432457048416f582b39484a6e446d6f466d786e6f4f4f386c513d3d000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001586d6d6a4c497a326e30574b78354c306442502f5577534c76717a416c364e35584b596e576979457845627872382f586f3575334b39546b7265345a6a7974464b667173736f54397a784a39452b48564f686f7a507757516d4d766f6558636e3856636175594e4c745a474d4f3548742b4d593375574259574141703447446b414d4d4a617939666f745457655675344a7248512f61442f4d43362b707531736a7067666e6e44677a6a734d4539473362676668733854616c67386a5163325042516247504a5238584154784f6b57667a64316e466c6536345736427146352f614d6f4b317644785948515335553345576a4134547545554752466749643150345a4a68325a6e57487861685a717038314354456a384e585675453639666f696d596f7a4a2b7758326a734a6671504964433570534a362f2f696d626c4a3437746f37524d724e584a59334f2f4c4c4c2b64585a3442773d3d000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000015864436957546b666138362f6e352b704d437772395066314e2f6c4e6b663179614444335a64686c764972496c5153344e46417761785239486b4d53466867535874713641613965456f52724f3352462b7a6c6e30713373485a472f62704d356b7a68696a6d52796e465952492b3973754d4d7173473166792b472b6d5244474d376d696e4d41754148667a66434763344b70457a31324846747170395155775546774367347450475255774e554b2b676976586178425730634e62553534344f335844554532634b4b653968595a6b4a515256356a4c7476425477616a714246383746332b435877477861344363695165664d74704a467376414c2f7a47495545447a463044494357756542496a4f305944452f2f6d56516a75556571446935557a36736d5277634969666c7833547837775676777966714273535464506f55476775723146717a6742646573687559434c4c5066773d3d0000000000000000",
   "blockNumber":"0x6332B1",
   "transactionHash":"0x07bc195a03f5b9ff3adfbb629d4956567daa83c3e59c701beb54342db65ea558",
   "transactionIndex":"0x0",
   "blockHash":"0xc19e1e28ca532a4a4d1b6d4f2350d1c1aa669cc1c65a4112e56606554b8cc2d2",
   "logIndex":"0x1",
   "removed":false
}`

	t.Run("legacy validator added", func(t *testing.T) {
		vLogValidatorAdded, contractAbi := unmarshalLog(t, legacyRawValidatorAdded, Legacy)
		abiParser := NewParser(logex.Build("test", zap.InfoLevel, nil), Legacy)
		parsed, err := abiParser.ParseValidatorAddedEvent(*vLogValidatorAdded, contractAbi)
		var malformedEventErr *abiparser.MalformedEventError
		require.NoError(t, err)
		require.NotNil(t, contractAbi)
		require.False(t, errors.As(err, &malformedEventErr))
		require.NotNil(t, parsed)
		require.Equal(t, "91db3a13ab428a6c9c20e7104488cb6961abeab60e56cf4ba199eed3b5f6e7ced670ecb066c9704dc2fa93133792381c", hex.EncodeToString(parsed.PublicKey))
	})

	t.Run("v2 validator added", func(t *testing.T) {
		t.Skip()
		vLogValidatorAdded, contractAbi := unmarshalLog(t, rawValidatorAddedV2, V2)
		abiParser := NewParser(logex.Build("test", zap.InfoLevel, nil), V2)
		parsed, err := abiParser.ParseValidatorAddedEvent(*vLogValidatorAdded, contractAbi)
		var malformedEventErr *abiparser.MalformedEventError
		require.NoError(t, err)
		require.NotNil(t, contractAbi)
		require.False(t, errors.As(err, &malformedEventErr))
		require.NotNil(t, parsed)
		require.Equal(t, "a49871a0b87d674435ac1bb62bb78a27a29bc0901ad7a3b77e564c02644f55da0e72c18e888ca78f8290a8b9c0825dd2", hex.EncodeToString(parsed.PublicKey))
		require.Equal(t, "0xFeedB14D8b2C76FdF808C29818b06b830E8C2c0e", parsed.OwnerAddress.Hex())
		operators := []string{"LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBN2pXcExremd2TXdvRzhNdEVyUjIKRGhUMk11dElmYUd0VmxMeDVWK2g4amwrdnlxT1YvcmxKREVlQy9HMzVpV0M0WEU3RnFKUVc1QmpvQWZ1TXhQegpRQzZ6MEE1b1I3enRuWHU2c0V3TkhJSFh3REFITHlTdVdQM3BGYlo0Qnc5b1FZTUJmbVNsL3hXR0syVnN3aVhkCkNFcUZKRmdNUFk3NlJQY0o2R2dkTWcrWVRRWVVFamlRTjFpdmJKZjRWaUpCRTcrbVNteFZNNTAzVmlyQWZndkIKenBndTNzdHZIdHpRV1Z2eHJ0NTR0Rm9DMHRmWE1RRXNSU0VtTVRoVkhocVorZTJCOC9kTWQ2R1FodnE5ZXR1RQphQkxoSlpFUXlpMklpUU02Ulg2a01vZGdGUmcvemttTFZXQ0VITzEzaFV5Rkoxang1L0M5bEIyU2VENW9jd1h4CmJRSURBUUFCCi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS0K", "LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBb3pVaGFzSG9HeE1YS3pUbzgrSHcKWGV0enJtWENYOTdteXBpaHhjL2wxSEllSVVwV2V3NkFNMzlPd1JQZ2VVMFZ3QmQ2NHZhbzZsTTNaQWxTdVZlMgpablN0T01JckJTWGVsYkc0b1BrRG5xZkNNbGJma1RNRlhXVFowdE1IdGJwVkU3N2o0aEpxaUI3ZU13YitwNXUxClovNmVxWjZmRWRnODI5MzN3ZUhhVWNzd2ZJQmhYNlNaUjNlMkJvRUJ2bHljNE5ENEFoNVFaZjMrRWpxSit5dHYKc3hiRm5MNUpLWWhjSlc4YmtCdzNoM2VreUYyY2I2eUE3M3dsTzZhWklaRWJ4QkE0WDl4WjhMSFBaNHJYWG9GbwpoMVFCd1IxOUVhemF5b0h1TmJkWGpBbU9hc1ViT0ttNFJBdk9ya1FwZ1I4S0J4NGMzczk0OFlidTBJRktQb0NICkJ3SURBUUFCCi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS0K", "LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBcjZXc09kMzJZVStPeVowVVZtUlYKQkhEREtLM2U1OTRpUzV2dHRLMVJiMlVYd3YwNGZKcGd4L1NQWmlqUmE0eFdmc3ZsaTMxeHg1c2srMlh6OTJ1VQo5TlE4OGRlL0YxemJtanQwM25wWjhaS253cm1LOXZURE9PZFY4M1RiMUNYTzFhb3J2eVM1MERiZTlSbHE2SGNDCnVuTTRaQnk0SHdvZ2pBZjY2YTFCc085eGx2Rjc0UEgrRTJ0Q1k0ZVYwL1M4VFdHbjh4R0dITW5GT0l1UmRMUTAKemMvQ0pPVjBIK1daSEVEZTcyNU8wR1AwTXV0QmNHZWE1R3A4ckZwWHkvMDFBdmlXajBnMDdqMFR1M0hZN0dlSwovZVNTL1hWOGJURG44M0ZQbE54WHdyVml3czl0cGxzTFMxeUxSN0xxT2NYYVl4NHRLY3FrVTQ0UFhmem9UeC9BCmh3SURBUUFCCi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS0K", "LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBdVIzV0hmU1lhWlE0NjkxenR0aTYKZlBBcExqa29LcysrQS90QWdSVXdHbEhXYm5iNjJPVU4ra0tTUU53VWlNMFRwWGdOVHVSNGpjdWdKa1NTRlRSRAp5WEwvSXRpbzlFZHE3aEhRQ3BEQ0xCVFNYRlNtMjJrNlNRbllGeWs3UVNndnoyQW9mOXJ6YVdBQmVmUkZPdUs5CnFWT00rbzhnRnFwcXlQRnRJRy9CVS9Fb1l2M0FNU1A5UWJCTXRXSkIvcTd2QStZMUFrZEJiYUNuaGFkK1FUWGwKY1VkSzRabHZ1NVdFWkxLdC9OMlU1RGQwaFh4RXBuRlo3L01SNVRnRVl2NFl3aUpHeWNyRTFKWGVSU2MrM21DWQpKekVzYjJPWTBTZE83YjBMcWdqM2hVa0RtcEdVS2NoQlQyaGw0NWJ5ak4valZjUW1rb29lYUgzSCt2R2IvNzhVCkV3SURBUUFCCi0tLS0tRU5EIFJTQSBQVUJMSUMgS0VZLS0tLS0K"}
		for i, pk := range parsed.OperatorPublicKeys {
			require.Equal(t, operators[i], string(pk))
		}
		shares := []string{"90d8b15e48a65c48e0e90184c345ac49db1073550841087150199f9e25f76595662104703c46b12f1001cbba59211361", "896d999a3cbbb4b3a462fefdb351b2f94f4c14bb44abe99701c77632140d807d3c5b46e8f66e67e8479d787e87636e10", "a0a90424720deede84ecea2d5855c3b56d53726d585fc32c52c239b317d6c4d93abb4938556c81a42c6fed0e0c60cd74", "9177946b30a048cb6b29037c6c1d72cf61bd9a093497d40f93df8df76e813de5d64c74114f5373e8c18d7c8634e0a400"}
		for i, pk := range parsed.SharesPublicKeys {
			require.Equal(t, shares[i], hex.EncodeToString(pk))
		}
	})
}

func unmarshalLog(t *testing.T, rawOperatorAdded string, abiVersion Version) (*types.Log, abi.ABI) {
	var vLogOperatorAdded types.Log
	err := json.Unmarshal([]byte(rawOperatorAdded), &vLogOperatorAdded)
	require.NoError(t, err)
	contractAbi, err := abi.JSON(strings.NewReader(ContractABI(abiVersion)))
	require.NoError(t, err)
	require.NotNil(t, contractAbi)
	return &vLogOperatorAdded, contractAbi
}
